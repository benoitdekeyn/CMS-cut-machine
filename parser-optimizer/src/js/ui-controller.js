import { DataManager } from './data-manager.js';
import { AlgorithmService } from './algorithm-service.js';
import { ImportManager } from './import-manager.js';
import { PgmGenerator } from './pgm-generator.js';
import { PgmManager } from './pgm-manager.js';
import { ResultsRenderer } from './results-renderer.js';

// Importer les gestionnaires UI
import { ImportHandler } from './ui/import-handler.js';
import { EditHandler } from './ui/edit-handler.js';
import { ResultsHandler } from './ui/results-handler.js';
import { NotificationService } from './ui/notification-service.js';
import { UIUtils } from './ui/utils.js';

/**
 * Contr√¥leur d'interface utilisateur principal
 * Coordonne les diff√©rentes sections et services
 */
export const UIController = {
  // Services et gestionnaires
  dataManager: null,
  algorithmService: null,
  importManager: null,
  pgmGenerator: null,
  pgmManager: null,
  
  // Gestionnaires UI
  importHandler: null,
  editHandler: null,
  resultsHandler: null,
  notificationService: null,
  
  // √âtat de l'application
  currentResults: null,
  currentPgmObjects: null,
  
  /**
   * Initialise le contr√¥leur et tous les services
   */
  init: async function() {
    try {
      console.log('üöÄ Initialisation de l\'application...');
      
      // Initialiser les services principaux
      this.initializeServices();
      
      // Initialiser les gestionnaires UI
      await this.initializeUIHandlers();
      
      // Configurer les gestionnaires d'√©v√©nements
      this.setupEventListeners();
      
      console.log('‚úÖ Application initialis√©e avec succ√®s');
      
    } catch (error) {
      console.error('‚ùå Erreur lors de l\'initialisation:', error);
      this.showNotification('Erreur lors de l\'initialisation de l\'application', 'error');
    }
  },
  
  /**
   * Initialise les services principaux
   */
  initializeServices: function() {
    // Initialiser le service de notification en premier
    this.notificationService = NotificationService;
    this.notificationService.init();
    
    // Initialiser les autres services
    this.dataManager = DataManager;
    this.algorithmService = AlgorithmService;
    this.importManager = ImportManager;
    this.pgmGenerator = PgmGenerator;
    this.pgmManager = PgmManager;
    
    console.log('üìã Services principaux initialis√©s');
  },
  
  /**
   * Initialise les gestionnaires d'interface utilisateur
   */
  initializeUIHandlers: async function() {
    try {
      // Initialiser les gestionnaires avec leurs d√©pendances
      this.importHandler = ImportHandler;
      this.importHandler.init({
        importManager: this.importManager,
        dataManager: this.dataManager,
        showNotification: (msg, type) => this.showNotification(msg, type),
        refreshDataDisplay: () => this.refreshDataDisplay()
      });
      
      this.editHandler = EditHandler;
      this.editHandler.init({
        dataManager: this.dataManager,
        showNotification: (msg, type) => this.showNotification(msg, type),
        refreshDataDisplay: () => this.refreshDataDisplay()
      });
      
      this.resultsHandler = ResultsHandler;
      this.resultsHandler.init({
        pgmGenerator: this.pgmGenerator,
        dataManager: this.dataManager,
        uiController: this,
        showNotification: (msg, type) => this.showNotification(msg, type)
      });
      
      // AJOUTER : Rendre les sections d'√©dition apr√®s initialisation
      this.editHandler.renderSection();
      
      console.log('üé® Gestionnaires UI initialis√©s');
      
    } catch (error) {
      console.error('‚ùå Erreur lors de l\'initialisation des gestionnaires UI:', error);
      throw error;
    }
  },
  
  /**
   * Configure tous les gestionnaires d'√©v√©nements
   */
  setupEventListeners: function() {
    try {
      console.log('üîó Configuration des gestionnaires d\'√©v√©nements...');
      
      // CORRECTION : Utiliser le bon ID du bouton
      const setupOptimizeButton = () => {
        const optimizeBtn = document.getElementById('generate-cuts-btn'); // ‚úÖ Bon ID
        if (optimizeBtn) {
          console.log('‚úÖ Bouton de g√©n√©ration trouv√©');
          
          // Supprimer les anciens listeners pour √©viter les doublons
          optimizeBtn.replaceWith(optimizeBtn.cloneNode(true));
          
          // R√©cup√©rer le nouveau bouton et ajouter le listener
          const newOptimizeBtn = document.getElementById('generate-cuts-btn'); // ‚úÖ Bon ID
          newOptimizeBtn.addEventListener('click', (e) => {
            console.log('üéØ Clic sur le bouton de g√©n√©ration d√©tect√©');
            e.preventDefault();
            
            // Pas de s√©lection d'algorithme dans le HTML actuel, utiliser la comparaison par d√©faut
            const algorithmType = 'compare';
            console.log(`üîç Algorithme s√©lectionn√©: ${algorithmType}`);
            
            this.runOptimization(algorithmType);
          });
          
          console.log('‚úÖ Event listener attach√© au bouton de g√©n√©ration');
        } else {
          console.warn('‚ö†Ô∏è Bouton de g√©n√©ration non trouv√©');
        }
      };
      
      // Configurer le bouton d'optimisation
      setupOptimizeButton();
      
      // Gestionnaire pour le bouton "Retour aux donn√©es"
      const setupBackButton = () => {
        const backBtn = document.getElementById('back-to-data-btn');
        if (backBtn) {
          backBtn.addEventListener('click', () => {
            this.showSection('data');
          });
          console.log('‚úÖ Event listener attach√© au bouton de retour');
        }
      };
      
      setupBackButton();
      
      // Gestionnaire pour le t√©l√©chargement de tous les PGM
      const setupDownloadButton = () => {
        const downloadAllBtn = document.getElementById('download-all-pgm');
        if (downloadAllBtn) {
          downloadAllBtn.addEventListener('click', () => {
            this.resultsHandler.downloadAllPgm();
          });
          console.log('‚úÖ Event listener attach√© au bouton de t√©l√©chargement');
        }
      };
      
      setupDownloadButton();
      
      // Configuration des onglets de navigation
      this.setupNavigationTabs();
      
      console.log('‚úÖ Gestionnaires d\'√©v√©nements configur√©s');
      
    } catch (error) {
      console.error('‚ùå Erreur lors de la configuration des √©v√©nements:', error);
    }
  },
  
  /**
   * Configure les onglets de navigation
   */
  setupNavigationTabs: function() {
    const navButtons = document.querySelectorAll('[data-section]'); // ‚úÖ Utiliser data-section
    
    navButtons.forEach(button => {
      button.addEventListener('click', (e) => {
        const sectionName = e.target.getAttribute('data-section');
        this.showSection(sectionName);
      });
    });
  },
  
  /**
   * Affiche une section sp√©cifique
   */
  showSection: function(sectionName) {
    // Cacher toutes les sections
    const sections = document.querySelectorAll('.content-section');
    sections.forEach(section => {
      section.classList.remove('active');
    });
    
    // Afficher la section demand√©e
    const targetSection = document.getElementById(sectionName);
    if (targetSection) {
      targetSection.classList.add('active');
    }
    
    // Mettre √† jour les boutons de navigation
    const navButtons = document.querySelectorAll('[data-section]');
    navButtons.forEach(button => {
      button.classList.remove('active');
      if (button.getAttribute('data-section') === sectionName) {
        button.classList.add('active');
      }
    });
  },
  
  /**
   * Lance l'optimisation des d√©coupes
   * @param {string} algorithmType - Type d'algorithme √† utiliser
   */
  runOptimization: async function(algorithmType = 'compare') {
    try {
      // V√©rifier qu'il y a des donn√©es
      const data = this.dataManager.getData();
      if (!this.validateDataForOptimization(data)) {
        return;
      }
      
      UIUtils.showLoadingOverlay();
      this.showNotification('Optimisation en cours...', 'info');
      
      // Lancer l'algorithme
      console.log(`üßÆ Lancement de l'optimisation (${algorithmType})`);
      const results = this.algorithmService.runAlgorithm(algorithmType, data);
      
      if (!results) {
        throw new Error('Aucun r√©sultat retourn√© par l\'algorithme');
      }
      
      // Stocker les r√©sultats
      this.currentResults = results;
      
      // G√©n√©rer les objets PGM
      console.log('üîß G√©n√©ration des objets PGM...');
      this.currentPgmObjects = this.pgmManager.generatePgmObjects(results, this.dataManager);
      
      // Afficher le rapport de synth√®se des PGM
      const summaryReport = this.pgmManager.generateSummaryReport(this.currentPgmObjects);
      console.log('üìä Rapport PGM:', summaryReport);
      
      // Rendre les r√©sultats
      ResultsRenderer.renderResults(results, this.algorithmService);
      
      // G√©n√©rer les aper√ßus PGM
      this.resultsHandler.generatePgmPreviews(results);
      
      // Afficher les onglets de r√©sultats
      this.showResultsTabs();
      
      this.showNotification(`Optimisation termin√©e - ${summaryReport.totalPgmObjects} barres √† d√©couper`, 'success');
      
    } catch (error) {
      console.error('‚ùå Erreur lors de l\'optimisation:', error);
      this.showNotification(`Erreur lors de l'optimisation: ${error.message}`, 'error');
      this.currentResults = null;
      this.currentPgmObjects = null;
    } finally {
      UIUtils.hideLoadingOverlay();
    }
  },
  
  /**
   * Valide les donn√©es pour l'optimisation
   * @param {Object} data - Donn√©es √† valider
   * @returns {boolean} True if valid
   */
  validateDataForOptimization: function(data) {
    if (!data.pieces || Object.keys(data.pieces).length === 0) {
      this.showNotification('Aucune pi√®ce √† d√©couper n\'a √©t√© import√©e', 'warning');
      return false;
    }
    
    if (!data.motherBars || Object.keys(data.motherBars).length === 0) {
      this.showNotification('Aucune barre m√®re n\'a √©t√© d√©finie', 'warning');
      return false;
    }
    
    return true;
  },
  
  /**
   * Affiche les onglets de r√©sultats
   */
  showResultsTabs: function() {
    // Basculer vers l'onglet r√©sultats
    this.showSection('result-section');
  },
  
  /**
   * Rafra√Æchit l'affichage des donn√©es
   */
  refreshDataDisplay: function() {
    try {
      const data = this.dataManager.getData();
      
      // Mettre √† jour les compteurs
      this.updateDataCounters(data);
      
      // Rafra√Æchir les tableaux si ils sont visibles
      if (this.editHandler) {
        this.editHandler.renderSection();
      }
      
      console.log('üîÑ Affichage des donn√©es rafra√Æchi');
      
    } catch (error) {
      console.error('‚ùå Erreur lors du rafra√Æchissement:', error);
    }
  },
  
  /**
   * Met √† jour les compteurs de donn√©es
   * @param {Object} data - Donn√©es actuelles
   */
  updateDataCounters: function(data) {
    try {
      // Compter les pi√®ces
      let totalPieces = 0;
      for (const profile in data.pieces) {
        totalPieces += data.pieces[profile].length;
      }
      
      // Compter les barres m√®res
      let totalMotherBars = 0;
      for (const profile in data.motherBars) {
        totalMotherBars += data.motherBars[profile].length;
      }
      
      // Mettre √† jour l'interface
      const piecesCounter = document.getElementById('pieces-counter');
      if (piecesCounter) {
        piecesCounter.textContent = totalPieces;
      }
      
      const motherBarsCounter = document.getElementById('mother-bars-counter');
      if (motherBarsCounter) {
        motherBarsCounter.textContent = totalMotherBars;
      }
      
    } catch (error) {
      console.error('‚ùå Erreur lors de la mise √† jour des compteurs:', error);
    }
  },
  
  /**
   * Efface toutes les donn√©es
   */
  clearAllData: function() {
    if (confirm('√ätes-vous s√ªr de vouloir effacer toutes les donn√©es ?')) {
      this.dataManager.clearAllData();
      this.currentResults = null;
      this.currentPgmObjects = null;
      
      // Rafra√Æchir l'affichage
      this.refreshDataDisplay();
      
      // Cacher les r√©sultats
      const resultsSection = document.getElementById('results-section');
      if (resultsSection) {
        resultsSection.style.display = 'none';
      }
      
      this.showNotification('Toutes les donn√©es ont √©t√© effac√©es', 'info');
    }
  },
  
  /**
   * Affiche une notification
   * @param {string} message - Message √† afficher
   * @param {string} type - Type de notification
   */
  showNotification: function(message, type = 'info') {
    if (this.notificationService) {
      this.notificationService.show(message, type);
    } else {
      console.log(`${type.toUpperCase()}: ${message}`);
    }
  },
  
  /**
   * R√©cup√®re les objets PGM actuels
   * @returns {Array|null} Liste des objets PGM ou null
   */
  getCurrentPgmObjects: function() {
    return this.currentPgmObjects;
  },
  
  /**
   * Affiche les informations de debug des objets PGM
   */
  debugPgmObjects: function() {
    if (!this.currentPgmObjects) {
      console.log('Aucun objet PGM disponible');
      return;
    }
    
    console.log('üîç Debug des objets PGM:');
    console.log(`Total: ${this.currentPgmObjects.length} objets`);
    
    this.currentPgmObjects.forEach((pgm, index) => {
      console.log(`\n--- PGM ${index + 1} ---`);
      console.log(`ID: ${pgm.id}`);
      console.log(`Barre m√®re: ${pgm.motherBar.profile} (${pgm.motherBar.orientation}) - ${pgm.motherBar.length}cm`);
      console.log(`Pi√®ces: ${pgm.pieces.length}`);
      pgm.pieces.forEach((piece, pieceIndex) => {
        console.log(`  ${pieceIndex + 1}. ${piece.length}cm ‚Üí ${piece.pieceReference.nom || piece.pieceReference.id}`);
      });
    });
  }
};